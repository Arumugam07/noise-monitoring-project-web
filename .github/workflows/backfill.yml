name: Backfill Noise Data

on:
  workflow_dispatch:  # Manual trigger

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install python-dotenv supabase requests python-dateutil
    
    - name: Create .env file
      run: |
        echo "SUPABASE_URL=https://tgznxzfdlxhxqwpohhyl.supabase.co" >> .env
        echo "SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnem54emZkbHhoeHF3cG9oaHlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3NTQxMTgsImV4cCI6MjA2OTMzMDExOH0.FzoEYy49ZeAGxW7SLF0biuO3aMvc6vETwovRrfZEalU" >> .env
        echo "API_BASE_URL=http://139.59.223.231:3000/api/meter-sound" >> .env
        echo "SUPABASE_TABLE=meter_readings" >> .env
        echo "EMPTY_CHUNKS_TO_STOP=7" >> .env
        echo "BACKFILL_MAX_YEARS=1" >> .env
    
    - name: Run backfill script
      run: |
        python supabase_backfill_all.py
      
    - name: Summary
      if: always()
      run: |
        echo "Backfill completed!"
        echo "Check Supabase table for data"
